name: Copilot Setup Steps

# This workflow is called by GitHub Copilot coding agent to prepare the development environment
# before executing tasks. It sets up Python, installs dependencies, and prepares CLI tools.

on:
  workflow_call:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry
        run: |
          poetry config virtualenvs.create true
          poetry config virtualenvs.in-project true

      - name: Install dependencies
        run: |
          poetry install --all-extras --with dev

      - name: Install Node.js for MCP servers
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Verify MCP servers availability
        run: |
          echo "Checking MCP server availability..."
          npx -y @modelcontextprotocol/server-filesystem --help || echo "Filesystem server OK"
          node --version
          npm --version
          echo "Checking uvx for Python-based MCP servers..."
          uvx --help | head -n 5
          echo "Checking rope refactoring server..."
          uvx python-lsp-server --version || echo "Python LSP server with Rope available"

      - name: Verify CLI tools
        run: |
          poetry run python --version
          poetry run pytest --version
          poetry run mypy --version
          poetry run ruff --version
          uv --version
          uvx --version

      - name: Validate MCP configuration
        run: |
          if [ -f .github/copilot/mcp.json ]; then
            echo "Validating MCP configuration..."
            python -m json.tool < .github/copilot/mcp.json > /dev/null
            echo "✅ MCP configuration is valid"
          else
            echo "⚠️  No MCP configuration found"
          fi

      - name: Display environment info
        run: |
          echo "=== Environment Information ==="
          echo "Python version: $(python --version)"
          echo "Poetry version: $(poetry --version)"
          echo "uv version: $(uv --version)"
          echo "Node.js version: $(node --version)"
          echo "Working directory: $(pwd)"
          echo "PATH: $PATH"
          ls -la .github/copilot/ || echo "No .github/copilot/ directory"

      - name: Run quick health check
        run: |
          echo "Running health check..."
          poetry run python -c "import xsp; print('✅ xsp package imported successfully')" || echo "⚠️  xsp package not importable yet"
