name: Auto Update PRs

# Automatically updates all open PRs with latest main branch changes
# Creates GitHub issues for PRs with merge conflicts for batch resolution

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force:
        description: 'Force update even if conflicts exist'
        required: false
        default: false
        type: boolean

jobs:
  update-prs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure labels exist
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create labels if they don't exist
          gh label create "merge-conflict" --description "PR has merge conflicts with main" --color "d73a4a" --force || true
          gh label create "auto-update" --description "Automated update process" --color "0e8a16" --force || true
          gh label create "needs-batch-resolve" --description "Awaiting batch conflict resolution" --color "fbca04" --force || true

      - name: Update all open PRs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” Fetching open pull requests..."
          
          # Get all open PRs
          prs=$(gh pr list --state open --json number,headRefName,title,author --jq '.[] | "\(.number)|\(.headRefName)|\(.title)|\(.author.login)"')
          
          if [ -z "$prs" ]; then
            echo "â„¹ï¸  No open pull requests found"
            exit 0
          fi
          
          echo "ğŸ“‹ Found $(echo "$prs" | wc -l) open PR(s)"
          echo ""
          
          # Track conflicts for summary
          conflict_count=0
          success_count=0
          
          # Process each PR
          echo "$prs" | while IFS='|' read -r pr_number branch_name pr_title pr_author; do
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ğŸ”„ PR #$pr_number: $pr_title"
            echo "   Branch: $branch_name"
            echo "   Author: @$pr_author"
            
            # Get current HEAD SHA for safety check
            head_sha=$(gh pr view $pr_number --json headRefOid -q .headRefOid)
            echo "   Current HEAD: ${head_sha:0:7}"
            
            # Attempt to update the branch
            update_response=$(gh api \
              repos/${{ github.repository }}/pulls/$pr_number/update-branch \
              -X PUT \
              -f expected_head_sha="$head_sha" 2>&1)
            
            update_status=$?
            
            if [ $update_status -eq 0 ]; then
              echo "   âœ… Successfully queued for update"
              success_count=$((success_count + 1))
              
              # Add a comment to the PR
              gh pr comment $pr_number --body "ğŸ¤– **Auto-update**: Branch updated with latest changes from \`main\`
              
<details>
<summary>Update details</summary>

- Triggered by: push to \`main\`
- Commit: \`${{ github.sha }}\`
- Workflow: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

</details>" || echo "   âš ï¸  Could not add comment"
            else
              # Check if it's a conflict error
              if echo "$update_response" | grep -q "merge conflict\|422"; then
                echo "   âš ï¸  MERGE CONFLICT detected"
                conflict_count=$((conflict_count + 1))
                
                # Check if issue already exists for this PR
                existing_issue=$(gh issue list \
                  --label "merge-conflict" \
                  --search "PR #$pr_number merge conflicts" \
                  --state open \
                  --json number \
                  --jq '.[0].number' || echo "")
                
                if [ -n "$existing_issue" ] && [ "$existing_issue" != "null" ]; then
                  echo "   â„¹ï¸  Issue #$existing_issue already exists - updating"
                  
                  # Update existing issue
                  gh issue comment $existing_issue --body "ğŸ”„ **Conflict still present** as of commit \`${head_sha:0:7}\`

Attempted auto-update at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                else
                  echo "   ğŸ“ Creating issue for batch resolution"
                  
                  # Create new issue
                  issue_body="## ğŸ”€ Merge Conflict Detected

**Pull Request:** #$pr_number - $pr_title  
**Branch:** \`$branch_name\`  
**Author:** @$pr_author  
**Conflicting with:** \`main\` @ \`${{ github.sha }}\`

### ğŸ“Š Context

This PR has merge conflicts with the latest \`main\` branch and requires manual resolution.

### ğŸ¤– Batch Resolution

This issue is tagged for **batch conflict resolution**. A scheduled agent will:
1. Analyze all open conflict issues
2. Determine common patterns
3. Create a single PR with resolutions for multiple conflicts
4. Request human review before merging

### ğŸ› ï¸ Manual Resolution (if urgent)

\`\`\`bash
git fetch origin
git checkout $branch_name
git merge origin/main
# Resolve conflicts in your editor
git add .
git commit -m 'chore: resolve merge conflicts with main'
git push
\`\`\`

Or use GitHub's web editor: [Resolve conflicts in PR #$pr_number](${{ github.server_url }}/${{ github.repository }}/pull/$pr_number)

### ğŸ“‹ Conflict Details

<details>
<summary>API Response</summary>

\`\`\`
$update_response
\`\`\`

</details>

---

**Auto-generated** by workflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                  
                  new_issue=$(gh issue create \
                    --title "ğŸ”€ Merge conflict: PR #$pr_number ($pr_title)" \
                    --body "$issue_body" \
                    --label "merge-conflict,auto-update,needs-batch-resolve" \
                    --assignee "$pr_author")
                  
                  echo "   âœ… Created issue: $new_issue"
                  
                  # Link issue in PR
                  gh pr comment $pr_number --body "âš ï¸ **Auto-update failed**: Merge conflicts detected

ğŸ“‹ **Issue created**: $new_issue

This conflict will be resolved in a **batch PR** by an automated agent. You can also resolve it manually if urgent (see issue for instructions).

---
<sub>Triggered by: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>"
                fi
              else
                echo "   âŒ Update failed: $update_response"
              fi
            fi
            
            echo ""
            sleep 2  # Rate limiting protection
          done
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "âœ¨ PR update process completed"
          echo "ğŸ“Š Summary: $success_count updated, $conflict_count conflicts"

      - name: Summary
        if: always()
        run: |
          echo "### ğŸ“Š Auto-Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Base branch: \`main\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Updated PRs are ready for review" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ Conflicted PRs have issues created with label \`needs-batch-resolve\`" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¤– Batch resolution agent will process conflicts periodically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View all conflict issues](https://github.com/${{ github.repository }}/issues?q=is:issue+is:open+label:needs-batch-resolve)" >> $GITHUB_STEP_SUMMARY

