# Copilot Instructions for xsp-lib

**Version:** 1.0  
**Last Updated:** December 10, 2025, 7:08 PM MSK  
**Status:** Active Planning - Phase 1 (Foundation)

---

## Project Overview

**xsp-lib** is a **universal AdTech service protocol library** providing:

### Upstream Protocols
- VAST/VPAID/VMAP (video ad serving)
- OpenRTB 2.x/3.x (real-time bidding)
- DAAST (digital audio ad serving)
- CATS (common AdTech services)

### Infrastructure
- Pluggable transports (HTTP, gRPC, WebSocket, file, memory)
- Middleware system (retry, circuit breaker, cache, metrics)
- Session management (frequency capping, budget tracking)
- Configuration abstraction (transport-agnostic)

---

## Current Phase: Phase 1 - Foundation

**Status:** 60% Complete | **Timeline:** 2 weeks remaining | **Target:** December 23, 2025

### Phase 1 Goal
Establish core abstractions, session management, and documentation foundation for all subsequent phases.

### Phase 1 Deliverables

| # | Component | Status | Issue | PR | Effort |
|---|-----------|--------|-------|----|---------|
| 1 | UpstreamConfig | ‚úÖ Merged | #38 | #63 | DONE |
| 2 | Orchestrator | ‚úÖ Merged | - | #62 | DONE |
| 3 | TOML Validation | ‚úÖ Merged | #22 | #60 | DONE |
| 4 | HTTP Transport | ‚úÖ Merged | - | #58, #64 | DONE |
| 5 | **SessionContext** | ‚è≥ Pending | #37 | #67 | 3 hrs |
| 6 | **UpstreamSession** | ‚è≥ Pending | #37 | #67 | 3 hrs |
| 7 | **@configurable** | ‚è≥ Pending | #15 | #68 | 3 hrs |
| 8 | **Arch Docs** | ‚è≥ Pending | #35 | #69 | 4 hrs |
| 9 | **Session Guide** | ‚è≥ Pending | #36 | #70 | 3 hrs |

**Phase 1 Effort:** 25-30 hours total (16-18 hours remaining)

### Phase 1 Success Criteria

- [ ] SessionContext immutable (frozen dataclass)
- [ ] UpstreamSession protocol with state methods
- [ ] @configurable decorator system working with registry
- [ ] Configuration template generation
- [ ] 30+ unit tests (95%+ coverage)
- [ ] mypy --strict: 0 errors
- [ ] 6000+ words of documentation
- [ ] All examples working

---

## Architecture Decisions

### Decision 1: Close PR #61 (Redundant)

**Status:** ‚ùå Close as superseded

**Reason:** PR #61 proposed configuration architecture separation (UpstreamConfig + HttpClientConfig). This exact solution was already implemented and merged in **PR #63**.

**Evidence:**

| Feature | PR #61 | PR #63 | Status |
|---------|--------|--------|--------|
| UpstreamConfig dataclass | Proposed | ‚úÖ Delivered (src/xsp/core/config.py) | DONE |
| merge_params() method | Proposed | ‚úÖ Delivered | DONE |
| merge_headers() method | Proposed | ‚úÖ Delivered | DONE |
| Transport-agnostic design | Proposed | ‚úÖ Delivered | DONE |
| Unit tests | Proposed | ‚úÖ 13+ tests | DONE |
| Type hints (mypy strict) | Assumed | ‚úÖ Full compliance | DONE |
| Production ready | Draft | ‚úÖ Merged to main | DONE |

**Action:** Close PR #61 with explanation that it's superseded by PR #63

### Decision 2: Defer PR #60 (Optional Enhancement)

**Status:** ‚è∏Ô∏è Defer to post-Phase 1

**Reason:** PR #60 adds TOML syntax validation (tomlkit integration). While quality implementation, it's an optional enhancement not on critical path.

**Impact:**
- ‚úÖ Not blocking Phase 1
- ‚úÖ Not blocking Phase 2
- ‚úÖ Zero impact on timeline
- ‚úÖ Can be merged anytime

**Action:** Defer until Phase 1 complete (target: mid-January 2025)

### Decision 3: Block PR #65 (Breaking Changes for Phase 2)

**Status:** üö´ Block until Phase 2

**Reason:** PR #65 proposes breaking API changes (fetch ‚Üí request, send ‚Üí request). These should be coordinated in Phase 2 (Protocol Handlers), not Phase 1.

**Conflicts:**
- Would break 4 merged PRs (#58, #62, #63, #64)
- Conflicts with SessionContext.request() (PR #57)
- Breaking changes need coordinated Phase 2 refactoring

**Action:** Close with explanation that terminology refactoring belongs in Phase 2

### Decision 4: Lock Phase 1 Scope

**Status:** ‚úÖ Scope locked to 4 PRs

**Phase 1 PRs (No changes):**
- PR #67: SessionContext + UpstreamSession
- PR #68: @configurable decorator system
- PR #69: Architecture documentation
- PR #70: Session management guide + examples

**Phase 1 Constraints:**
- ‚úÖ No breaking changes
- ‚úÖ Foundation-only work
- ‚úÖ Session management + config system focus
- ‚úÖ Clear, achievable in 2 weeks

---

## Immediate Action Items (Next 2 Weeks)

### Week 1: Dec 10-16 (Core Implementation)

**Day 1-2 (Dec 10-11): PR #67 - SessionContext + UpstreamSession**

```python
# Create src/xsp/core/session.py

from dataclasses import dataclass

@dataclass(frozen=True)
class SessionContext:
    """Immutable session context for ad serving."""
    timestamp: int                    # Unix timestamp (ms)
    correlator: str                   # Unique session ID
    cachebusting: str                 # Cache-busting random
    cookies: dict[str, str]           # HTTP cookies
    request_id: str                   # Request tracing ID

class UpstreamSession(Protocol):
    """Stateful session for ad serving."""
    
    @property
    def context(self) -> SessionContext:
        """Get immutable session context."""
        ...
    
    async def request(self, *, params: dict[str, Any] | None = None) -> str:
        """Send request within session context."""
        ...
    
    async def check_frequency_cap(self, user_id: str) -> bool:
        """Check if user exceeded frequency cap."""
        ...
    
    async def track_budget(self, campaign_id: str, amount: float) -> None:
        """Track budget spend for campaign."""
        ...
    
    async def close(self) -> None:
        """Release session resources."""
        ...
```

**Deliverables:**
- SessionContext (frozen dataclass)
- UpstreamSession protocol
- 10+ unit tests
- Complete docstrings

**Timeline:** 3 hours | **Target:** EOD Dec 11

**Day 2-3 (Dec 12-13): PR #68 - @configurable Decorator**

```python
# Create src/xsp/core/configurable.py

from dataclasses import dataclass
from typing import get_type_hints
import inspect

@dataclass
class ParameterInfo:
    name: str
    type: type | str
    default: Any
    description: str | None = None

@dataclass
class ConfigMetadata:
    cls: type
    namespace: str
    description: str | None
    parameters: dict[str, ParameterInfo]

_CONFIGURABLE_REGISTRY: dict[str, ConfigMetadata] = {}

def configurable(*, namespace: str | None = None, description: str | None = None):
    """Mark class as configurable for configuration generation."""
    def decorator(cls: type[T]) -> type[T]:
        # Extract parameters from __init__
        # Only keyword-only args with defaults
        # Register in global registry
        # Store metadata on class
        return cls
    return decorator

def get_configurable_registry() -> dict[str, ConfigMetadata]:
    """Get all registered configurable classes."""
    return _CONFIGURABLE_REGISTRY.copy()
```

**Deliverables:**
- @configurable decorator
- ConfigMetadata + ParameterInfo dataclasses
- Global registry system
- TOML template generation
- 12+ unit tests

**Timeline:** 3 hours | **Target:** Dec 12-13

**Day 3-4 (Dec 13-14): PR #69 - Architecture Documentation**

**Deliverables:**
- docs/architecture/final-architecture.md (3000+ words)
- docs/architecture/session-management.md (1000+ words)
- docs/architecture/terminology.md (500+ words)

**Timeline:** 4 hours | **Target:** Dec 13-14

### Week 2: Dec 16-23 (Guides & Merge)

**Day 5 (Dec 15-16): PR #70 - Session Management Guide**

**Deliverables:**
- docs/guides/session-management.md (1500+ words)
- docs/guides/stateful-ad-serving.md (1500+ words)
- examples/session_management.py
- examples/frequency_capping.py
- examples/budget_tracking.py

**Timeline:** 2 hours | **Target:** Dec 15-16

**Day 6-7 (Dec 16-23): Code Review & Merge**

- Review all PRs #67-70
- Address feedback
- Run full test suite
- Verify type checking (mypy --strict)
- Merge to main

**Timeline:** 2 hours | **Target:** Dec 23

---

## Key Architectural Patterns

### Pattern 1: Transport-Agnostic Configuration

```python
# Configuration is separate from transport
config = UpstreamConfig(
    endpoint="https://ads.example.com/vast",
    params={"publisher": "pub123"},
    headers={"User-Agent": "xsp-lib/1.0"},
    encoding_config={"url": False},  # Preserve Cyrillic
    timeout=30.0,
    max_retries=3
)

# Use with different transports
http_upstream = VastUpstream(transport=HttpTransport(), config=config)
test_upstream = VastUpstream(transport=MemoryTransport(), config=config)
```

### Pattern 2: Session-Based State Management

```python
# Create immutable session context
context = SessionContext(
    timestamp=int(time.time() * 1000),
    correlator="session-abc123",
    cachebusting="rand-456789",
    cookies={"uid": "user123"},
    request_id="req-001"
)

# Create session for stateful operations
session = await upstream.create_session(context)

# Check frequency cap
if await session.check_frequency_cap("user123", limit=3):
    ad = await session.request(params={"slot": "pre-roll"})
    await session.track_budget("campaign-456", 2.50)
else:
    ad = await fallback_upstream.request(params={...})

await session.close()
```

### Pattern 3: Configurable Class Registration

```python
@configurable(
    namespace="vast",
    description="VAST protocol upstream for video ad serving"
)
class VastUpstream(BaseUpstream[str]):
    def __init__(
        self,
        transport: Transport,
        endpoint: str,
        *,  # Keyword-only args below are configurable
        version: VastVersion = VastVersion.V4_2,
        enable_macros: bool = True,
        validate_xml: bool = False,
        timeout: float = 30.0,
    ):
        super().__init__(transport=transport, endpoint=endpoint)
        self.version = version
        self.validate_xml = validate_xml
        self.macro_substitutor = MacroSubstitutor() if enable_macros else None

# Generate TOML template from all @configurable classes
template = ConfigGenerator.generate_toml()
print(template)  # [vast]\nversion = "4.2"\n...
```

---

## Reference Documents

All detailed planning documents are committed to repository:

### 1. **[IMPLEMENTATION_PLAN.md](IMPLEMENTATION_PLAN.md)** (29.4 KB)
- Complete 4-phase roadmap (9-13 weeks, 100-120 hours)
- Detailed breakdown of Phases 2-4
- Resource allocation
- Risk mitigation (14 identified risks)
- Success metrics
- PR strategy
- Testing approach
- Documentation requirements
- Deployment strategy

### 2. **[ARCHITECTURE_DECISION_LOG.md](ARCHITECTURE_DECISION_LOG.md)** (12.2 KB)
- PR #61 analysis (why it's redundant)
- PR #60 decision (defer to post-Phase 1)
- PR #65 decision (block until Phase 2)
- Phase 1 scope locked
- All 33 issues analyzed
- Immediate action items
- Dependency graph
- Timeline

### 3. **[2025-12-10_COMPREHENSIVE_ANALYSIS.md](2025-12-10_COMPREHENSIVE_ANALYSIS.md)** (21.5 KB)
- Complete thread context
- All 33 open issues analyzed
- Current state vs required state
- Architecture layer breakdown (5 layers)
- Phase-by-phase details
- Risk assessment
- Resource allocation
- Documentation requirements

---

## Phase Overview (All 4 Phases)

### Phase 1: Foundation (Dec 10-23, 2025)
**16-18 hours remaining | Goal: Core abstractions & session management**

‚úÖ Merged: 5 PRs (UpstreamConfig, Orchestrator, TOML, HTTP Transport)  
‚è≥ Pending: 4 PRs (SessionContext, @configurable, Arch Docs, Guides)

### Phase 2: Protocol Handlers (Jan 6-20, 2025)
**20-25 hours | Goal: Protocol abstraction layer & terminology**

- ProtocolHandler ABC
- Terminology refactoring (fetch‚Üírequest, send‚Üírequest)
- AdRequest/AdResponse schemas
- Type-safe request/response handling

### Phase 3: Advanced Features (Jan 20-Feb 10, 2025)
**30-35 hours | Goal: Orchestrator & advanced features**

- ChainResolver with sessions
- VastProtocolHandler
- Protocol-agnostic Orchestrator
- StateBackend abstraction (Redis + In-Memory)
- Integration tests

### Phase 4: Production Features (Feb 10-24, 2025)
**25-30 hours | Goal: Production-ready capabilities**

- Frequency capping
- Budget tracking
- Dialer abstraction
- Performance optimization
- Production examples

---

## Testing Standards

### Phase 1 Test Requirements

```python
# tests/unit/core/test_session.py
# 10+ tests for SessionContext
- test_session_context_immutable
- test_session_context_frozen_dataclass
- test_session_context_creation

# tests/unit/core/test_configurable.py
# 12+ tests for @configurable
- test_decorator_registration
- test_parameter_extraction
- test_kwonly_params_only
- test_toml_generation
- test_special_characters_in_strings
- test_unicode_in_values

# tests/integration/
# 8+ integration tests
- test_session_lifecycle
- test_session_with_frequency_capping
```

### Success Threshold

- **Line Coverage:** 95%+ on src/xsp/core/
- **Test Count:** 30+ tests
- **Type Safety:** mypy --strict with 0 errors
- **Performance:** All tests < 1 second total
- **Integration:** 8+ integration tests

---

## Code Quality Standards

### Type Checking
```bash
mypy src/xsp/core/ --strict
```

### Linting
```bash
ruff check src/xsp/
```

### Testing
```bash
pytest tests/ -v --cov=xsp --cov-report=term-missing
```

### Code Coverage Target
- Phase 1 core: 95%+
- Overall project: 90%+

---

## Common Issues & Solutions

### Issue: SessionContext Immutability
**Solution:** Use frozen dataclass with @dataclass(frozen=True)

### Issue: Configuration Registry Complexity
**Solution:** Use simple dict-based registry, extract params via inspection

### Issue: Type Checking with Protocols
**Solution:** Use typing.Protocol with @runtime_checkable if needed

### Issue: TOML Generation Edge Cases
**Solution:** Use tomlkit or tomli_w for proper escaping

---

## Questions & Answers

**Q: Do we need PR #61?**  
A: ‚ùå NO. PR #63 already implemented the exact solution. Close as superseded.

**Q: Is the architecture stable?**  
A: ‚úÖ YES. 5 merged PRs, no conflicts, clear dependencies.

**Q: When will Phase 1 complete?**  
A: December 23, 2025 (2 weeks from today).

**Q: What's the total effort for all 4 phases?**  
A: 100-120 hours over 9-13 weeks (Jan-Apr 2025).

**Q: Can Phase 1 start immediately?**  
A: ‚úÖ YES. No blockers, clear plan, ready to execute.

---

## Important Notes for Copilot

### Context to Maintain

1. **Current Phase:** Phase 1 (Foundation) - 60% complete
2. **Timeline:** 2 weeks remaining (Dec 10-23)
3. **Next 4 PRs:** #67-70 (SessionContext, Configurable, Docs, Guides)
4. **No Blockers:** Can start implementation immediately
5. **Architecture:** Stable, no conflicts, clear path

### Key Decisions Made

1. **Close PR #61** - Superseded by PR #63
2. **Defer PR #60** - Optional, post-Phase 1
3. **Block PR #65** - Breaking changes for Phase 2
4. **Lock Phase 1 Scope** - 4 specific PRs only

### Success Criteria

- 30+ unit tests (95%+ coverage)
- mypy --strict: 0 errors
- 6000+ words documentation
- All examples working
- Phase 1 complete by Dec 23

---

## Related Issues

**Parent Issue:** #34 (Phase 1: Foundation)

**Phase 1 Issues:**
- #35 (Architecture documentation)
- #36 (Session management guide)
- #37 (SessionContext + UpstreamSession)
- #38 (UpstreamConfig dataclass) - ‚úÖ Merged (#63)
- #15 (@configurable decorator)

**Phase 2-4 Issues:**
- #40 (Phase 2: Protocol handlers)
- #42 (Phase 3: Advanced features)
- #44 (Phase 4: Production features)

---

## Document Maintenance

**Update Frequency:** Weekly (Mondays)  
**Last Updated:** December 10, 2025, 7:08 PM MSK  
**Next Review:** December 17, 2025

**When to Update:**
- After each PR merge
- When Phase completes
- When blockers identified
- When timeline changes

---

**Status:** ‚úÖ ACTIVE - Ready to Execute  
**Phase 1 Progress:** 60% complete, 40% remaining (16-18 hours)  
**Next Action:** Start PR #67 (SessionContext) this week

For detailed planning, see:
- IMPLEMENTATION_PLAN.md
- ARCHITECTURE_DECISION_LOG.md
- 2025-12-10_COMPREHENSIVE_ANALYSIS.md
